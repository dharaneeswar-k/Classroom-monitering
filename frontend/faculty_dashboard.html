<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Classroom - Faculty</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/faculty.css">
</head>

<body>
    <div class="dashboard-layout fade-in">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-brand">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                </svg>
                Smart Classroom
            </div>
            <div class="sidebar-item active" onclick="switchTab('session', this)">
                <div class="sidebar-item-content">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
                        <line x1="12" y1="22.08" x2="12" y2="12" />
                    </svg>
                    Live Session
                </div>
            </div>
            <div class="sidebar-item" onclick="switchTab('od', this)">
                <div class="sidebar-item-content">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                        <polyline points="10 9 9 9 8 9" />
                    </svg>
                    OD Requests
                </div>
                <span id="odBadge" class="badge badge-warning" style="display:none">0</span>
            </div>
            <div class="sidebar-item" onclick="switchTab('history', this)">
                <div class="sidebar-item-content">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                    </svg>
                    Attendance History
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="top-navbar">
                <h2 id="pageTitle" style="color: var(--text-main); font-weight: 600;">Live Classroom Monitoring</h2>
                <div class="user-profile">
                    <span id="userNameDisplay" style="font-weight: 500; color: var(--text-muted);">Faculty</span>
                    <div class="user-avatar" id="userInitials">FA</div>
                    <button class="btn btn-secondary" onclick="logout()" style="padding: 0.5rem 1rem;">Logout</button>
                </div>
            </div>

            <!-- Live Session Tab -->
            <div id="tab-session" class="tab-content animate-fade-in">

                <div class="session-controls">
                    <div style="flex: 1; min-width: 200px;">
                        <label class="form-label" style="margin-bottom: 0.25rem;">Select Assigned Classroom</label>
                        <select id="classroomSelect" class="form-control"
                            style="max-width: 300px; padding: 0.5rem 1rem;">
                            <option value="">Loading assigned rooms...</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label class="form-label" style="margin-bottom: 0.25rem;">Session Name</label>
                        <input type="text" id="sessionNameInput" class="form-control"
                            style="max-width: 300px; padding: 0.5rem 1rem;"
                            placeholder="e.g. Data Structures Lecture 1">
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: flex-end; padding-bottom: 2px; flex-wrap: wrap;">
                        <button id="startBtn" class="btn btn-primary" onclick="startSession()">Start Active
                            Session</button>
                        <button id="endBtn" class="btn btn-danger" style="display:none;" onclick="endSession()">End
                            Session</button>
                        <span id="sessionStatus"
                            style="color: var(--text-muted); font-weight: 500; padding: 0.5rem 1rem; border-radius: var(--radius-md); background: var(--bg-main);">No
                            active session</span>
                        <span id="sessionTimerDisplay" class="session-timer" style="display:none;">00:00:00</span>
                    </div>
                </div>

                <div id="liveDashboard" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Students Present</h3>
                            <div class="value" id="presentCount">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Absent / Undetected</h3>
                            <div class="value" id="absentCount" style="color: var(--danger);">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Avg Class Engagement</h3>
                            <div class="value" id="avgEngagement">0%</div>
                            <div class="engagement-bar">
                                <div id="engBar" class="engagement-fill" style="width: 0%; background: var(--success);">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div id="videoGrid" class="panel"
                            style="grid-column: span 3; padding: 1rem; border-radius: var(--radius-lg); background: #000; position: relative; min-height: 480px; display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 1rem; align-items: center; justify-content: center; overflow: hidden;">
                            <div id="videoPlaceholder"
                                style="color: #64748b; font-weight: 500; font-family: monospace; grid-column: 1 / -1; text-align: center;">
                                Awaiting AI Feed Initialization...
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
                            <h3 style="margin:0;">Live Attendance Feed</h3>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin: 0.25rem 0 0;">Auto-refreshing
                                every 3 seconds. Engagement ≤ 50% will be marked absent on session end.</p>
                        </div>
                        <div class="table-container"
                            style="border: none; border-radius: 0 0 var(--radius-lg) var(--radius-lg);">
                            <table class="data-table" id="attendanceTable">
                                <thead>
                                    <tr>
                                        <th>Register No</th>
                                        <th>Name</th>
                                        <th>Status</th>
                                        <th>Behavior Flags</th>
                                        <th>Engagement Score</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OD Requests Tab -->
            <div id="tab-od" class="tab-content hidden animate-fade-in">
                <div class="panel">
                    <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
                        <h3 style="margin:0;">Pending OD Requests</h3>
                    </div>
                    <div class="table-container"
                        style="border: none; border-radius: 0 0 var(--radius-lg) var(--radius-lg);">
                        <table class="data-table" id="odTable">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Requested Date</th>
                                    <th>Reason</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="tab-history" class="tab-content hidden animate-fade-in">
                <div class="session-controls">
                    <div style="flex: 1;">
                        <label class="form-label" style="margin-bottom: 0.25rem;">View History For Classroom</label>
                        <select id="historyClassroomSelect" class="form-control"
                            style="max-width: 300px; padding: 0.5rem 1rem;" onchange="loadHistoryForClassroom()">
                            <option value="">Select a classroom...</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end; padding-bottom: 2px;">
                        <div class="view-toggle">
                            <button id="btnDailyView" class="active" onclick="switchHistoryView('daily')">Daily
                                Rollup</button>
                            <button id="btnSessionView" onclick="switchHistoryView('session')">Session-Wise</button>
                        </div>
                    </div>
                </div>

                <!-- Daily Rollup View -->
                <div id="historyDailyView">
                    <div class="panel">
                        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
                            <h3 style="margin:0;">Daily Attendance Summary</h3>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin: 0.25rem 0 0;">Shows the
                                per-day attendance rollup across all sessions for each student.</p>
                        </div>
                        <div class="table-container"
                            style="border: none; border-radius: 0 0 var(--radius-lg) var(--radius-lg);">
                            <table class="data-table" id="historyTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Student</th>
                                        <th>Register No</th>
                                        <th>Sessions Attended</th>
                                        <th>Daily %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="5"
                                            style="text-align:center; color: var(--text-muted); padding: 2rem;">
                                            Select a classroom to view attendance rollups.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Session-Wise View -->
                <div id="historySessionView" style="display:none;">
                    <div id="sessionCardsList"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- Session Detail Modal -->
    <div id="sessionModal" class="modal-overlay" style="display:none;" onclick="closeModal(event)">
        <div class="modal-box">
            <div class="modal-header">
                <div>
                    <h3 id="modalSessionName" style="margin:0;"></h3>
                    <p id="modalSessionMeta" style="color:var(--text-muted); font-size:0.85rem; margin:0.25rem 0 0;">
                    </p>
                </div>
                <div style="display:flex; align-items:center; gap:1rem;">
                    <button class="btn btn-danger" id="btnDeleteSession"
                        style="padding: 0.4rem 0.8rem; font-size: 0.85rem; display: flex; align-items: center; gap: 0.4rem;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                            </path>
                        </svg>
                        Delete Session
                    </button>
                    <button class="modal-close"
                        onclick="document.getElementById('sessionModal').style.display='none'">✕</button>
                </div>
            </div>
            <div class="table-container" style="border: none;">
                <table class="data-table" id="modalAttendanceTable">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Register No</th>
                            <th>Status</th>
                            <th>Engagement</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <script src="js/faculty.js"></script>
</body>

</html>